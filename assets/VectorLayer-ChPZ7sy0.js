import{am as A,p as d,aX as u,c3 as f,c4 as L,m as D,o as p,y as m,U as R,X as v,ae as C,W as B,ac as I,af as N,aY as x}from"./GeoJSON-dVJCj0SI.js";import{M as P,V as w}from"./VectorStyleRenderer-W9NXHFGV.js";import{b as O,W,c as G}from"./RenderTarget-Dp0EIh_t.js";import{c as M,f as T}from"./mat4-CeypvY8Z.js";import{l as V,D as U}from"./compileUtil-DE-8w3AG.js";import{g as H}from"./worldUtil-B7XuFNW4.js";const l={...U,RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",GLOBAL_ALPHA:"u_globalAlpha"};class J extends V{constructor(e,t){const s={[l.RENDER_EXTENT]:[0,0,0,0],[l.PATTERN_ORIGIN]:[0,0],[l.GLOBAL_ALPHA]:1};super(e,{uniforms:s,postProcesses:t.postProcesses}),this.hitDetectionEnabled_=!t.disableHitDetection,this.hitRenderTarget_,this.sourceRevision_=-1,this.previousExtent_=A(),this.currentTransform_=d(),this.tmpCoords_=[0,0],this.tmpTransform_=d(),this.tmpMat4_=M(),this.currentFrameStateTransform_=d(),this.styleVariables_={},this.styles_=[],this.styleRenderers_=[],this.buffers_=[],this.applyOptions_(t),this.batch_=new P,this.initialFeaturesAdded_=!1,this.sourceListenKeys_=null}addInitialFeatures_(e){const t=this.getLayer().getSource();let s;this.batch_.addFeatures(t.getFeatures(),s),this.sourceListenKeys_=[u(t,f.ADDFEATURE,this.handleSourceFeatureAdded_.bind(this,s)),u(t,f.CHANGEFEATURE,this.handleSourceFeatureChanged_.bind(this,s),this),u(t,f.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),u(t,f.CLEAR,this.handleSourceFeatureClear_,this)]}applyOptions_(e){this.styleVariables_=e.variables,this.styles_=O(e.style)}createRenderers_(){this.buffers_=[],this.styleRenderers_=this.styles_.map(e=>new w(e,this.styleVariables_,this.helper,this.hitDetectionEnabled_,"filter"in e?e.filter:null))}reset(e){this.applyOptions_(e),this.helper&&this.createRenderers_(),super.reset(e)}afterHelperCreated(){this.styleRenderers_.length?this.styleRenderers_.forEach((e,t)=>e.setHelper(this.helper,this.buffers_[t])):this.createRenderers_(),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new W(this.helper))}handleSourceFeatureAdded_(e,t){const s=t.feature;this.batch_.addFeature(s,e)}handleSourceFeatureChanged_(e,t){const s=t.feature;this.batch_.changeFeature(s,e)}handleSourceFeatureDelete_(e){const t=e.feature;this.batch_.removeFeature(t)}handleSourceFeatureClear_(){this.batch_.clear()}applyUniforms_(e){L(this.tmpTransform_,this.currentFrameStateTransform_),D(this.tmpTransform_,e),this.helper.setUniformMatrixValue(l.PROJECTION_MATRIX,T(this.tmpMat4_,this.tmpTransform_)),p(this.tmpTransform_,this.tmpTransform_),this.helper.setUniformMatrixValue(l.SCREEN_TO_WORLD_MATRIX,T(this.tmpMat4_,this.tmpTransform_)),this.tmpCoords_[0]=0,this.tmpCoords_[1]=0,p(this.tmpTransform_,e),m(this.tmpTransform_,this.tmpCoords_),this.helper.setUniformFloatVec2(l.PATTERN_ORIGIN,this.tmpCoords_)}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[s,r,o]=H(e,this.getLayer());this.helper.prepareDraw(e),this.renderWorlds(e,!1,s,r,o),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const n=this.helper.getCanvas();return this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,s,r,o),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),n}prepareFrameInternal(e){this.initialFeaturesAdded_||(this.addInitialFeatures_(e),this.initialFeaturesAdded_=!0);const t=this.getLayer(),s=t.getSource(),r=e.viewState,o=!e.viewHints[R.ANIMATING]&&!e.viewHints[R.INTERACTING],n=!v(this.previousExtent_,e.extent),i=this.sourceRevision_<s.getRevision();if(i&&(this.sourceRevision_=s.getRevision()),o&&(n||i)){const c=r.projection,h=r.resolution,a=t instanceof C?t.getRenderBuffer():0,y=B(e.extent,a*h);s.loadFeatures(y,h,c),this.ready=!1;const g=this.helper.makeProjectionTransform(e,d()),E=this.styleRenderers_.map((b,_)=>b.generateBuffers(this.batch_,g).then(F=>{this.buffers_[_]&&this.disposeBuffers(this.buffers_[_]),this.buffers_[_]=F}));Promise.all(E).then(()=>{this.ready=!0,this.getLayer().changed()}),this.previousExtent_=e.extent.slice()}return!0}renderWorlds(e,t,s,r,o){let n=s;t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));do{this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_),I(this.currentFrameStateTransform_,n*o,0);for(let i=0,c=this.styleRenderers_.length;i<c;i++){const h=this.styleRenderers_[i],a=this.buffers_[i];a&&h.render(a,e,()=>{this.applyUniforms_(a.invertVerticesTransform),this.helper.applyHitDetectionUniform(t)})}}while(++n<r)}forEachFeatureAtCoordinate(e,t,s,r,o){if(N(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.styleRenderers_.length||!this.hitDetectionEnabled_)return;const n=m(t.coordinateToPixelTransform,e.slice()),i=this.hitRenderTarget_.readPixel(n[0]/2,n[1]/2),c=[i[0]/255,i[1]/255,i[2]/255,i[3]/255],h=G(c),a=this.batch_.getFeatureFromRef(h);if(a)return r(a,this.getLayer(),null)}disposeBuffers(e){const t=s=>{for(const r of s)r&&this.helper.deleteBuffer(r)};e.pointBuffers&&t(e.pointBuffers),e.lineStringBuffers&&t(e.lineStringBuffers),e.polygonBuffers&&t(e.polygonBuffers)}disposeInternal(){this.buffers_.forEach(e=>{e&&this.disposeBuffers(e)}),this.sourceListenKeys_&&(this.sourceListenKeys_.forEach(function(e){x(e)}),this.sourceListenKeys_=null),super.disposeInternal()}renderDeclutter(){}}export{J as W};
//# sourceMappingURL=VectorLayer-ChPZ7sy0.js.map
