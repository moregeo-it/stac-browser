import{aq as D,g as F,ar as L,f as l,W as y,v as O,E,Y as p,af as U,as as K,a2 as b,at as z,au as P,av as A}from"./GeoJSON-dVJCj0SI.js";import{T as G}from"./Tile-G7aX-9AV.js";import{T as j}from"./TileGrid-DzNPHZK1.js";import{e as w,c as Z}from"./Tile-oJI9PQZQ.js";import I from"./UrlTile-CFIfXLkZ.js";const R=[];class B extends G{constructor(e,i,t,r,o){super(e,i,{transition:0}),this.context_=null,this.executorGroups={},this.loadingSourceTiles=0,this.hitDetectionImageData={},this.replayState_={},this.sourceTiles=[],this.errorTileKeys={},this.wantedResolution,this.getSourceTiles=r.bind(void 0,this),this.removeSourceTiles_=o,this.wrappedTileCoord=t}getContext(){return this.context_||(this.context_=D(1,1,R)),this.context_}hasContext(){return!!this.context_}getImage(){return this.hasContext()?this.getContext().canvas:null}getReplayState(e){const i=F(e);return i in this.replayState_||(this.replayState_[i]={dirty:!1,renderedRenderOrder:null,renderedResolution:NaN,renderedRevision:-1,renderedTileResolution:NaN,renderedTileRevision:-1,renderedTileZ:-1}),this.replayState_[i]}load(){this.getSourceTiles()}release(){this.context_&&(L(this.context_),R.push(this.context_.canvas),this.context_=null),this.removeSourceTiles_(this),this.sourceTiles.length=0,super.release()}}let N=class extends G{constructor(e,i,t,r,o,s){super(e,i,s),this.extent=null,this.format_=r,this.features_=null,this.loader_,this.projection=null,this.resolution,this.tileLoadFunction_=o,this.url_=t,this.key=t}getTileUrl(){return this.url_}getFormat(){return this.format_}getFeatures(){return this.features_}load(){this.state==l.IDLE&&(this.setState(l.LOADING),this.tileLoadFunction_(this,this.url_),this.loader_&&this.loader_(this.extent,this.resolution,this.projection))}onLoad(e,i){this.setFeatures(e)}onError(){this.setState(l.ERROR)}setFeatures(e){this.features_=e,this.setState(l.LOADED)}setLoader(e){this.loader_=e}};class M extends I{constructor(e){const i=e.projection||"EPSG:3857",t=e.extent||w(i),r=e.tileGrid||Z({extent:t,maxResolution:e.maxResolution,maxZoom:e.maxZoom!==void 0?e.maxZoom:22,minZoom:e.minZoom,tileSize:e.tileSize||512});super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,interpolate:!0,projection:i,state:e.state,tileGrid:r,tileLoadFunction:e.tileLoadFunction?e.tileLoadFunction:v,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:e.wrapX===void 0?!0:e.wrapX,transition:e.transition,zDirection:e.zDirection===void 0?1:e.zDirection}),this.format_=e.format?e.format:null,this.tileKeysBySourceTileUrl_={},this.sourceTiles_={},this.overlaps_=e.overlaps==null?!0:e.overlaps,this.tileClass=e.tileClass?e.tileClass:N,this.tileGrids_={}}getOverlaps(){return this.overlaps_}getSourceTiles(e,i,t){if(t.getState()===l.IDLE){t.setState(l.LOADING);const r=t.wrappedTileCoord,o=this.getTileGridForProjection(i),s=o.getTileCoordExtent(r),n=r[0],g=o.getResolution(n);y(s,-g,s);const h=this.tileGrid,a=h.getExtent();a&&O(s,a,s);const f=h.getZForResolution(g,this.zDirection);h.forEachTileCoord(s,f,c=>{const d=this.tileUrlFunction(c,e,i);this.sourceTiles_[d]||(this.sourceTiles_[d]=new this.tileClass(c,d?l.IDLE:l.EMPTY,d,this.format_,this.tileLoadFunction));const u=this.sourceTiles_[d];t.sourceTiles.push(u),this.tileKeysBySourceTileUrl_[d]||(this.tileKeysBySourceTileUrl_[d]=[]),this.tileKeysBySourceTileUrl_[d].push(t.getKey());const _=u.getState();if(_<l.LOADED){const S=C=>{this.handleTileChange(C);const m=u.getState();if(m===l.LOADED||m===l.ERROR){const x=u.getKey();x in t.errorTileKeys?u.getState()===l.LOADED&&delete t.errorTileKeys[x]:t.loadingSourceTiles--,m===l.ERROR?t.errorTileKeys[x]=!0:u.removeEventListener(E.CHANGE,S),t.loadingSourceTiles===0&&t.setState(P(t.errorTileKeys)?l.LOADED:l.ERROR)}};u.addEventListener(E.CHANGE,S),t.loadingSourceTiles++}_===l.IDLE&&(u.extent=h.getTileCoordExtent(c),u.projection=i,u.resolution=h.getResolution(c[0]),u.load())}),t.loadingSourceTiles||t.setState(t.sourceTiles.some(c=>c.getState()===l.ERROR)?l.ERROR:l.LOADED)}return t.sourceTiles}removeSourceTiles(e){const i=e.getKey(),t=e.sourceTiles;for(let r=0,o=t.length;r<o;++r){const s=t[r].getTileUrl();if(!this.tileKeysBySourceTileUrl_[s])return;const n=this.tileKeysBySourceTileUrl_[s].indexOf(i);n!==-1&&(this.tileKeysBySourceTileUrl_[s].splice(n,1),this.tileKeysBySourceTileUrl_[s].length===0&&(delete this.tileKeysBySourceTileUrl_[s],delete this.sourceTiles_[s]))}}getTile(e,i,t,r,o){const s=[e,i,t];let n=this.getTileCoordForTileUrlFunction(s,o);const g=this.getTileGrid().getExtent(),h=this.getTileGridForProjection(o);if(n&&g){const c=h.getTileCoordExtent(n);y(c,-h.getResolution(e),c),p(g,c)||(n=null)}let a=!0;if(n!==null){const c=this.tileGrid,d=h.getResolution(e),u=c.getZForResolution(d,1),_=h.getTileCoordExtent(n);y(_,-d,_),c.forEachTileCoord(_,u,S=>{a=a&&!this.tileUrlFunction(S,r,o)})}const f=new B(s,a?l.EMPTY:l.IDLE,n,this.getSourceTiles.bind(this,r,o),this.removeSourceTiles.bind(this));return f.key=this.getKey(),f}getTileGridForProjection(e){const i=e.getCode();let t=this.tileGrids_[i];if(!t){const r=this.getProjection();U(r===null||K(r,e),"A VectorTile source can only be rendered if it has a projection compatible with the view projection.");const o=this.tileGrid,s=o.getResolutions().slice(),n=s.map(function(a,f){return o.getOrigin(f)}),g=s.map(function(a,f){return o.getTileSize(f)}),h=A+1;for(let a=s.length;a<h;++a)s.push(s[a-1]/2),n.push(n[a-1]),g.push(g[a-1]);t=new j({extent:o.getExtent(),origins:n,resolutions:s,tileSizes:g}),this.tileGrids_[i]=t}return t}getTilePixelRatio(e){return e}getTilePixelSize(e,i,t){const r=this.getTileGridForProjection(t),o=b(r.getTileSize(e),this.tmpSize);return[Math.round(o[0]*i),Math.round(o[1]*i)]}setOverlaps(e){this.overlaps_=e,this.changed()}}function v(T,e){T.setLoader(function(i,t,r){z(e,T.getFormat(),i,t,r,T.onLoad.bind(T),T.onError.bind(T))})}const $=Object.freeze(Object.defineProperty({__proto__:null,default:M,defaultLoadFunction:v},Symbol.toStringTag,{value:"Module"}));export{M as V,N as a,$ as b,v as d};
//# sourceMappingURL=VectorTile-C-k2biOI.js.map
