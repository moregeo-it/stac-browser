import{p as W,U as O,g as D,f as M,v as Y,W as H,X as q,Y as P,Z as $,_ as J,R as Q,y as ee,$ as te,a0 as re,a1 as oe,a2 as ne,a3 as N,a4 as ie,a5 as se,a6 as Z,a7 as ce,m as le,a8 as z,a9 as ae,aa as k,ab as V,ac as de,ad as ue,ae as ge,af as he}from"./GeoJSON-DII1Qerq.js";import{C as pe}from"./TileLayer-C5Rwse32.js";import j from"./TileProperty-BF4LcWSy.js";import"./index-DPmgT0xU.js";import"./utils-B7F_ho2D.js";import"./_commonjsHelpers-CE1G-McA.js";import"./I18N-DlIXJTel.js";import"./BFormRadioGroup.vue_vue_type_script_setup_true_lang-LQBMttYK-DOMeCoku.js";import"./useStateClass-BGbSLWFN-BNuqkYB7.js";import"./ConditionalWrapper.vue_vue_type_script_lang-IX_NpHH--BXnPMu4c.js";import"./DataTile-DSUQcRYc.js";import"./Tile-CWLWzuLL.js";import"./Tile-C2uFJL5w.js";import"./common-C7eTg1SE.js";import"./TileRange-2Tc-Ry00.js";import"./LRUCache-Bdr1bElJ.js";import"./tilecoord-CR7vLr2I.js";const Te={image:["Polygon","Circle","LineString","Image","Text"],hybrid:["Polygon","LineString"],vector:[]},B={hybrid:["Image","Text","Default"],vector:["Polygon","Circle","LineString","Image","Text","Default"]};class fe extends pe{constructor(e,t){super(e,t),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.renderedLayerRevision_,this.renderedPixelToCoordinateTransform_=null,this.renderedRotation_,this.renderedOpacity_=1,this.tmpTransform_=W(),this.tileClipContexts_=null}drawTile(e,t,n,o,i,l,a,r){this.updateExecutorGroup_(e,t.pixelRatio,t.viewState.projection),this.tileImageNeedsRender_(e)&&this.renderTileImage_(e,t),super.drawTile(e,t,n,o,i,l,a,r)}getTile(e,t,n,o){const i=this.getOrCreateTile(e,t,n,o);if(!i)return null;const a=o.viewState.resolution,r=o.viewHints;return(!(r[O.ANIMATING]||r[O.INTERACTING])||!i.wantedResolution)&&(i.wantedResolution=a),i}prepareFrame(e){const t=this.getLayer().getRevision();return this.renderedLayerRevision_!==t&&(this.renderedLayerRevision_=t,this.renderedTiles.length=0),super.prepareFrame(e)}updateExecutorGroup_(e,t,n){const o=this.getLayer(),i=o.getRevision(),l=o.getRenderOrder()||null,a=e.wantedResolution,r=e.getReplayState(o);if(!r.dirty&&r.renderedResolution===a&&r.renderedRevision==i&&r.renderedRenderOrder==l)return;const s=o.getSource(),d=!!o.getDeclutter(),x=s.getTileGrid(),R=s.getTileGridForProjection(n).getTileCoordExtent(e.wrappedTileCoord),p=s.getSourceTiles(t,n,e),g=D(o);delete e.hitDetectionImageData[g],e.executorGroups[g]=[],r.dirty=!1;for(let h=0,E=p.length;h<E;++h){const y=p[h];if(y.getState()!=M.LOADED)continue;const u=y.tileCoord,C=x.getTileCoordExtent(u),T=Y(R,C),v=H(T,o.getRenderBuffer()*a,this.tempExtent),f=q(C,T)?null:v,_=new $(0,T,a,t),L=ue(a,t),b=function(G,I){let F;const U=G.getStyleFunction()||o.getStyleFunction();if(U&&(F=U(G,a)),F){const K=this.renderFeature(G,L,F,_,d,I);r.dirty=r.dirty||K}},m=y.getFeatures();l&&l!==r.renderedRenderOrder&&m.sort(l);for(let G=0,I=m.length;G<I;++G){const F=m[G];(!f||P(f,F.getGeometry().getExtent()))&&b.call(this,F,G)}const S=_.finish(),A=o.getRenderMode()!=="vector"&&d&&p.length===1?null:T,w=new J(A,a,t,s.getOverlaps(),S,o.getRenderBuffer(),!0);e.executorGroups[g].push(w)}r.renderedRevision=i,r.renderedRenderOrder=l,r.renderedResolution=a}forEachFeatureAtCoordinate(e,t,n,o,i){const l=t.viewState.resolution,a=t.viewState.rotation;n=n??0;const r=this.getLayer(),d=r.getSource().getTileGridForProjection(t.viewState.projection),x=Q([e]);H(x,l*n,x);const c={},R=function(u,C,T){let v=u.getId();v===void 0&&(v=D(u));const f=c[v];if(f){if(f!==!0&&T<f.distanceSq){if(T===0)return c[v]=!0,i.splice(i.lastIndexOf(f),1),o(u,r,C);f.geometry=C,f.distanceSq=T}}else{if(T===0)return c[v]=!0,o(u,r,C);i.push(c[v]={feature:u,layer:r,geometry:C,distanceSq:T,callback:o})}},p=this.renderedTiles,g=D(r),h=r.getDeclutter(),E=h?t.declutter?.[h]?.all().map(u=>u.value):null;let y;e:for(let u=0,C=p.length;u<C;++u){const T=p[u],v=d.getTileCoordExtent(T.wrappedTileCoord);if(!P(v,x))continue;const f=T.executorGroups[g];for(let _=0,L=f.length;_<L;++_)if(y=f[_].forEachFeatureAtCoordinate(e,l,a,n,R,E),y)break e}return y}getFeatures(e){return this.renderedTiles.length===0?Promise.resolve([]):new Promise((t,n)=>{const o=this.getLayer(),i=o.getSource(),l=this.renderedProjection,a=l.getExtent(),r=this.renderedResolution,s=i.getTileGridForProjection(l),d=ee(this.renderedPixelToCoordinateTransform_,e.slice()),x=s.getTileCoordForCoordAndResolution(d,r).toString(),c=this.renderedTiles.find(u=>u.tileCoord.toString()===x&&u.getState()===M.LOADED);if(!c||c.loadingSourceTiles>0){t([]);return}i.getWrapX()&&l.canWrapX()&&!te(a,s.getTileCoordExtent(c.tileCoord))&&re(d,l);const R=D(o),p=s.getTileCoordExtent(c.wrappedTileCoord),g=oe(p),h=[(d[0]-g[0])/r,(g[1]-d[1])/r],E=c.getSourceTiles().reduce((u,C)=>u.concat(C.getFeatures()),[]);let y=c.hitDetectionImageData[R];if(!y){const u=ne(s.getTileSize(s.getZForResolution(r,i.zDirection))),C=this.renderedRotation_,T=[this.getRenderTransform(s.getTileCoordCenter(c.wrappedTileCoord),r,0,N,u[0]*N,u[1]*N,0)];y=ie(u,T,E,o.getStyleFunction(),s.getTileCoordExtent(c.wrappedTileCoord),c.getReplayState(o).renderedResolution,C),c.hitDetectionImageData[R]=y}t(se(h,E,y))})}getFeaturesInExtent(e){const t=[],n=this.getTileCache();if(n.getCount()===0)return t;const i=this.getLayer().getSource().getTileGridForProjection(this.frameState.viewState.projection),l=i.getZForResolution(this.renderedResolution),a={};return n.forEach(r=>{if(r.tileCoord[0]!==l||r.getState()!==M.LOADED)return;const s=r.getSourceTiles();for(let d=0,x=s.length;d<x;++d){const c=s[d],R=c.getKey();if(R in a)continue;a[R]=!0;const p=c.tileCoord;if(P(e,i.getTileCoordExtent(p))){const g=c.getFeatures();if(g)for(let h=0,E=g.length;h<E;++h){const y=g[h],u=y.getGeometry();P(e,u.getExtent())&&t.push(y)}}}}),t}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.renderedLayerRevision_!==void 0&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}renderDeclutter(e,t){const n=this.context,o=n.globalAlpha;n.globalAlpha=t.opacity;const i=e.viewHints,l=!(i[O.ANIMATING]||i[O.INTERACTING]),a=[this.context.canvas.width,this.context.canvas.height],r=this.getLayer().getDeclutter(),s=r?e.declutter?.[r]:void 0,d=D(this.getLayer()),x=this.renderedTiles;for(let c=0,R=x.length;c<R;++c){const p=x[c],g=p.executorGroups[d];if(g)for(let h=g.length-1;h>=0;--h)g[h].execute(this.context,a,this.getTileRenderTransform(p,e),e.viewState.rotation,l,Z,s)}n.globalAlpha=o}renderDeferredInternal(e){const t=this.renderedTiles,n=D(this.getLayer()),o=t.reduce((r,s,d)=>(s.executorGroups[n].forEach(x=>r.push({executorGroup:x,index:d})),r),[]),i=o.map(({executorGroup:r})=>r.getDeferredZIndexContexts()),l={};for(let r=0,s=o.length;r<s;++r){const d=o[r].executorGroup.getDeferredZIndexContexts();for(const x in d)l[x]=!0}Object.keys(l).map(Number).sort(ce).forEach(r=>{i.forEach((s,d)=>{s[r]&&(s[r].forEach(x=>{const{executorGroup:c,index:R}=o[d],p=c.getRenderedContext(),g=p.globalAlpha;p.globalAlpha=this.renderedOpacity_;const h=this.tileClipContexts_[R];h&&h.draw(p),x.draw(p),h&&p.restore(),p.globalAlpha=g,x.clear()}),s[r].length=0)})})}getTileRenderTransform(e,t){const n=t.pixelRatio,o=t.viewState,i=o.center,l=o.resolution,a=o.rotation,r=t.size,s=Math.round(r[0]*n),d=Math.round(r[1]*n),c=this.getLayer().getSource().getTileGridForProjection(t.viewState.projection),R=e.tileCoord,p=c.getTileCoordExtent(e.wrappedTileCoord),g=c.getTileCoordExtent(R,this.tempExtent)[0]-p[0];return le(z(this.inversePixelTransform.slice(),1/n,1/n),this.getRenderTransform(i,l,a,n,s,d,g))}postRender(e,t){const n=t.viewHints,o=!(n[O.ANIMATING]||n[O.INTERACTING]);this.renderedPixelToCoordinateTransform_=t.pixelToCoordinateTransform.slice(),this.renderedRotation_=t.viewState.rotation,this.renderedOpacity_=t.layerStatesArray[t.layerIndex].opacity;const i=this.getLayer(),l=i.getRenderMode(),a=e.globalAlpha;e.globalAlpha=this.renderedOpacity_;const r=i.getDeclutter(),s=r?B[l].filter(T=>!Z.includes(T)):B[l],d=t.viewState,x=d.rotation,c=i.getSource(),p=c.getTileGridForProjection(d.projection).getZForResolution(d.resolution,c.zDirection),g=this.renderedTiles,h=[],E=[],y=[],u=D(i);let C=!0;for(let T=g.length-1;T>=0;--T){const v=g[T];C=C&&!v.getReplayState(i).dirty;const f=v.executorGroups[u].filter(w=>w.hasExecutors(s));if(f.length===0)continue;const _=this.getTileRenderTransform(v,t),L=v.tileCoord[0];let b=!1;const m=f[0].getClipCoords(_);let S=e,A;if(m){A=new ae,S=A.getContext();for(let w=0,G=h.length;w<G;++w)if(p!==L&&L<E[w]){const I=h[w];P([m[0],m[3],m[4],m[7]],[I[0],I[3],I[4],I[7]])&&(b||(S.save(),b=!0),S.beginPath(),S.moveTo(m[0],m[1]),S.lineTo(m[2],m[3]),S.lineTo(m[4],m[5]),S.lineTo(m[6],m[7]),S.moveTo(I[6],I[7]),S.lineTo(I[4],I[5]),S.lineTo(I[2],I[3]),S.lineTo(I[0],I[1]),S.clip())}h.push(m),E.push(L)}for(let w=0,G=f.length;w<G;++w)f[w].execute(e,[e.canvas.width,e.canvas.height],_,x,o,s,t.declutter?.[r]);b&&(S===e?S.restore():y[T]=A)}e.globalAlpha=a,this.ready=C,this.tileClipContexts_=y,t.declutter||this.renderDeferredInternal(t),super.postRender(e,t)}renderFeature(e,t,n,o,i,l){if(!n)return!1;let a=!1;if(Array.isArray(n))for(let r=0,s=n.length;r<s;++r)a=k(o,e,n[r],t,this.boundHandleStyleImageChange_,void 0,i,l)||a;else a=k(o,e,n,t,this.boundHandleStyleImageChange_,void 0,i,l);return a}tileImageNeedsRender_(e){const t=this.getLayer();if(t.getRenderMode()==="vector")return!1;const n=e.getReplayState(t),o=t.getRevision(),i=e.wantedResolution;return n.renderedTileResolution!==i||n.renderedTileRevision!==o}renderTileImage_(e,t){const n=this.getLayer(),o=e.getReplayState(n),i=n.getRevision(),l=e.executorGroups[D(n)];o.renderedTileRevision=i;const a=e.wrappedTileCoord,r=a[0],s=n.getSource();let d=t.pixelRatio;const c=t.viewState.projection,R=s.getTileGridForProjection(c),p=R.getResolution(e.tileCoord[0]),g=t.pixelRatio/e.wantedResolution*p,h=R.getResolution(r),E=e.getContext();d=Math.round(Math.max(d,g/d));const y=s.getTilePixelSize(r,d,c);E.canvas.width=y[0],E.canvas.height=y[1];const u=d/g;if(u!==1){const f=V(this.tmpTransform_);z(f,u,u),E.setTransform.apply(E,f)}const C=R.getTileCoordExtent(a,this.tempExtent),T=g/h,v=V(this.tmpTransform_);z(v,T,-T),de(v,-C[0],-C[3]);for(let f=0,_=l.length;f<_;++f)l[f].execute(E,[E.canvas.width*u,E.canvas.height*u],v,0,!0,Te[n.getRenderMode()],null);o.renderedTileResolution=e.wantedResolution}}class Ae extends ge{constructor(e){e=e||{};const t=Object.assign({},e);delete t.preload;const n=e.cacheSize===void 0?0:e.cacheSize;delete e.cacheSize,delete t.useInterimTilesOnError,super(t),this.on,this.once,this.un,this.cacheSize_=n;const o=e.renderMode||"hybrid";he(o=="hybrid"||o=="vector","`renderMode` must be `'hybrid'` or `'vector'`"),this.renderMode_=o,this.setPreload(e.preload?e.preload:0),this.setUseInterimTilesOnError(e.useInterimTilesOnError!==void 0?e.useInterimTilesOnError:!0),this.getBackground,this.setBackground}createRenderer(){return new fe(this,{cacheSize:this.cacheSize_})}getFeatures(e){return super.getFeatures(e)}getFeaturesInExtent(e){return this.getRenderer().getFeaturesInExtent(e)}getRenderMode(){return this.renderMode_}getPreload(){return this.get(j.PRELOAD)}getUseInterimTilesOnError(){return this.get(j.USE_INTERIM_TILES_ON_ERROR)}setPreload(e){this.set(j.PRELOAD,e)}setUseInterimTilesOnError(e){this.set(j.USE_INTERIM_TILES_ON_ERROR,e)}}export{Ae as default};
//# sourceMappingURL=VectorTile-DXmKRTns.js.map
