import{e as v,d as b,W as B,a as F,c as D,p as L}from"./RenderTarget-C14E0H4Y.js";import{p,am as I,o as w,aX as _,c3 as g,g as m,U as y,X as x,ae as P,W as S,y as T,af as W,ac as U,m as G,aY as j,aD as N}from"./GeoJSON-DII1Qerq.js";import{l as O,D as z,a as C,b as M,p as E,E as k,o as f}from"./compileUtil-DqMMTWIK.js";import{g as V}from"./worldUtil-DWgfGy4C.js";import"./index-DPmgT0xU.js";import"./utils-B7F_ho2D.js";import"./_commonjsHelpers-CE1G-McA.js";import"./I18N-DlIXJTel.js";import"./BFormRadioGroup.vue_vue_type_script_setup_true_lang-LQBMttYK-DOMeCoku.js";import"./useStateClass-BGbSLWFN-BNuqkYB7.js";import"./ConditionalWrapper.vue_vue_type_script_lang-IX_NpHH--BXnPMu4c.js";import"./mat4-CeypvY8Z.js";import"./DataTile-DSUQcRYc.js";import"./Tile-CWLWzuLL.js";import"./Tile-C2uFJL5w.js";import"./common-C7eTg1SE.js";import"./TileRange-2Tc-Ry00.js";import"./LRUCache-Bdr1bElJ.js";import"./tilecoord-CR7vLr2I.js";class H extends O{constructor(e,t){const i=t.uniforms||{},n=p();i[z.PROJECTION_MATRIX]=n,super(e,{uniforms:i,postProcesses:t.postProcesses}),this.sourceRevision_=-1,this.verticesBuffer_=new C(M,E),this.indicesBuffer_=new C(k,E),this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.program_,this.hitDetectionEnabled_=t.hitDetectionEnabled??!0;const a=t.attributes?t.attributes.map(function(s){return{name:"a_"+s.name,size:1,type:f.FLOAT}}):[];this.attributes=[{name:"a_position",size:2,type:f.FLOAT},{name:"a_index",size:1,type:f.FLOAT}],this.hitDetectionEnabled_&&(this.attributes.push({name:"a_hitColor",size:4,type:f.FLOAT}),this.attributes.push({name:"a_featureUid",size:1,type:f.FLOAT})),this.attributes.push(...a),this.customAttributes=t.attributes?t.attributes:[],this.previousExtent_=I(),this.currentTransform_=n,this.renderTransform_=p(),this.invertRenderTransform_=p(),this.renderInstructions_=new Float32Array(0),this.hitRenderTarget_,this.lastSentId=0,this.worker_=v(),this.worker_.addEventListener("message",s=>{const h=s.data;if(h.type===b.GENERATE_POINT_BUFFERS){const o=h.projectionTransform;this.verticesBuffer_.fromArrayBuffer(h.vertexBuffer),this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.fromArrayBuffer(h.indexBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=o,w(this.invertRenderTransform_,this.renderTransform_),this.renderInstructions_=new Float32Array(s.data.renderInstructions),h.id===this.lastSentId&&(this.ready=!0),this.getLayer().changed()}}),this.featureCache_={},this.featureCount_=0;const r=this.getLayer().getSource();this.sourceListenKeys_=[_(r,g.ADDFEATURE,this.handleSourceFeatureAdded_,this),_(r,g.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),_(r,g.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),_(r,g.CLEAR,this.handleSourceFeatureClear_,this)],r.forEachFeature(s=>{const h=s.getGeometry();h&&h.getType()==="Point"&&(this.featureCache_[m(s)]={feature:s,properties:s.getProperties(),flatCoordinates:h.getFlatCoordinates()},this.featureCount_++)})}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new B(this.helper)),this.verticesBuffer_.getArray()&&this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.getArray()&&this.helper.flushBufferData(this.indicesBuffer_)}handleSourceFeatureAdded_(e){const t=e.feature,i=t.getGeometry();i&&i.getType()==="Point"&&(this.featureCache_[m(t)]={feature:t,properties:t.getProperties(),flatCoordinates:i.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureChanged_(e){const t=e.feature,i=m(t),n=this.featureCache_[i],a=t.getGeometry();n?a&&a.getType()==="Point"?(n.properties=t.getProperties(),n.flatCoordinates=a.getFlatCoordinates()):(delete this.featureCache_[i],this.featureCount_--):a&&a.getType()==="Point"&&(this.featureCache_[i]={feature:t,properties:t.getProperties(),flatCoordinates:a.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureDelete_(e){const t=e.feature,i=m(t);i in this.featureCache_&&(delete this.featureCache_[i],this.featureCount_--)}handleSourceFeatureClear_(){this.featureCache_={},this.featureCount_=0}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[i,n,a]=V(e,this.getLayer());return this.renderWorlds(e,!1,i,n,a),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent),this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,i,n,a),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),this.helper.getCanvas()}prepareFrameInternal(e){const t=this.getLayer(),i=t.getSource(),n=e.viewState,a=!e.viewHints[y.ANIMATING]&&!e.viewHints[y.INTERACTING],r=!x(this.previousExtent_,e.extent),s=this.sourceRevision_<i.getRevision();if(s&&(this.sourceRevision_=i.getRevision()),a&&(r||s)){const h=n.projection,o=n.resolution,c=t instanceof P?t.getRenderBuffer():0,d=S(e.extent,c*o);i.loadFeatures(d,o,h),this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()}return this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes),!0}rebuildBuffers_(e){const t=p();this.helper.makeProjectionTransform(e,t);const n=(this.hitDetectionEnabled_?7:2)+this.customAttributes.length,a=n*this.featureCount_,r=this.renderInstructions_&&this.renderInstructions_.length===a?this.renderInstructions_:new Float32Array(a);this.renderInstructions_=null;let s=[];const h=[];let o=-1;e.viewState.projection;for(const d in this.featureCache_){const l=this.featureCache_[d];if(s[0]=l.flatCoordinates[0],s[1]=l.flatCoordinates[1],T(t,s),r[++o]=s[0],r[++o]=s[1],this.hitDetectionEnabled_){const u=F(o+5,h);r[++o]=u[0],r[++o]=u[1],r[++o]=u[2],r[++o]=u[3],r[++o]=Number(d)}for(let u=0;u<this.customAttributes.length;u++){const A=this.customAttributes[u].callback(l.feature,l.properties);r[++o]=A}}const c={id:++this.lastSentId,type:b.GENERATE_POINT_BUFFERS,renderInstructions:r.buffer,customAttributesSize:n-2};c.projectionTransform=t,this.ready=!1,this.worker_.postMessage(c,[r.buffer])}forEachFeatureAtCoordinate(e,t,i,n,a){if(W(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.renderInstructions_||!this.hitDetectionEnabled_)return;const r=T(t.coordinateToPixelTransform,e.slice()),s=this.hitRenderTarget_.readPixel(r[0]/2,r[1]/2),h=[s[0]/255,s[1]/255,s[2]/255,s[3]/255],o=D(h),c=this.renderInstructions_[o],d=Math.floor(c).toString(),u=this.getLayer().getSource().getFeatureByUid(d);if(u)return n(u,this.getLayer(),null)}renderWorlds(e,t,i,n,a){let r=i;this.helper.useProgram(this.program_,e),t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0)),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes);do{this.helper.makeProjectionTransform(e,this.currentTransform_),U(this.currentTransform_,r*a,0),G(this.currentTransform_,this.invertRenderTransform_),this.helper.applyUniforms(e),this.helper.applyHitDetectionUniform(t);const s=this.indicesBuffer_.getSize();this.helper.drawElements(0,s)}while(++r<n)}disposeInternal(){this.worker_.terminate(),this.sourceListenKeys_.forEach(function(e){j(e)}),this.sourceListenKeys_=null,super.disposeInternal()}renderDeclutter(){}}class de extends N{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.parseResult_=L(e.style,this.styleVariables_,e.filter),this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){const e=Object.keys(this.parseResult_.attributes).map(t=>({name:t,...this.parseResult_.attributes[t]}));return new H(this,{vertexShader:this.parseResult_.builder.getSymbolVertexShader(),fragmentShader:this.parseResult_.builder.getSymbolFragmentShader(),hitDetectionEnabled:!this.hitDetectionDisabled_,uniforms:this.parseResult_.uniforms,attributes:e})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}export{de as default};
//# sourceMappingURL=WebGLPoints-BsGN4I8f.js.map
