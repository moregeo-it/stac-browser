import{ac as O,p as f,E as u,c4 as T,o as d,m as V,v as I}from"./GeoJSON-DII1Qerq.js";import{b as A,p as S,W as k,S as F}from"./RenderTarget-C14E0H4Y.js";import{M as B,V as D}from"./VectorStyleRenderer-D4k21ZLG.js";import{c as x,f as h}from"./mat4-CeypvY8Z.js";import{B as U,a as E,b as P,S as R,q as N,r as v,E as w,o as C}from"./compileUtil-DqMMTWIK.js";import G from"./BaseTile-cCAH7WRe.js";import"./index-DPmgT0xU.js";import"./utils-B7F_ho2D.js";import"./_commonjsHelpers-CE1G-McA.js";import"./I18N-DlIXJTel.js";import"./BFormRadioGroup.vue_vue_type_script_setup_true_lang-LQBMttYK-DOMeCoku.js";import"./useStateClass-BGbSLWFN-BNuqkYB7.js";import"./ConditionalWrapper.vue_vue_type_script_lang-IX_NpHH--BXnPMu4c.js";import"./DataTile-DSUQcRYc.js";import"./Tile-CWLWzuLL.js";import"./Tile-C2uFJL5w.js";import"./common-C7eTg1SE.js";import"./TileRange-2Tc-Ry00.js";import"./LRUCache-Bdr1bElJ.js";import"./tilecoord-CR7vLr2I.js";import"./TileProperty-BF4LcWSy.js";class X extends U{constructor(e,t){super(e),this.batch_=new B,this.styleRenderers_=t,this.buffers=[],this.maskVertices=new E(P,R),this.setTile(e.tile)}generateMaskBuffer_(){const e=this.tile.getSourceTiles()[0].extent;this.maskVertices.fromArray([e[0],e[1],e[2],e[1],e[2],e[3],e[0],e[3]]),this.helper.flushBufferData(this.maskVertices)}uploadTile(){this.generateMaskBuffer_(),this.batch_.clear();const e=this.tile.getSourceTiles(),t=e.reduce((l,n)=>l.concat(n.getFeatures()),[]);this.batch_.addFeatures(t);const s=e[0].extent[0],i=e[0].extent[1],a=O(f(),-s,-i),c=this.styleRenderers_.map((l,n)=>l.generateBuffers(this.batch_,a).then(m=>{this.buffers[n]=m}));Promise.all(c).then(()=>{this.setReady()})}disposeInternal(){this.buffers.forEach(e=>{this.disposeBuffers(e)}),super.disposeInternal()}disposeBuffers(e){if(!e)return;const t=s=>{for(const i of s)i&&this.helper.deleteBuffer(i)};e.pointBuffers&&t(e.pointBuffers),e.lineStringBuffers&&t(e.lineStringBuffers),e.polygonBuffers&&t(e.polygonBuffers)}}const r={...v,TILE_MASK_TEXTURE:"u_depthMask",TILE_ZOOM_LEVEL:"u_tileZoomLevel"},H={POSITION:"a_position"};class W extends N{constructor(e,t){super(e,{cacheSize:t.cacheSize,uniforms:{[r.PATTERN_ORIGIN]:[0,0],[r.TILE_MASK_TEXTURE]:()=>this.tileMaskTarget_.getTexture()}}),this.hitDetectionEnabled_=!t.disableHitDetection,this.styles_=[],this.styleVariables_=t.variables||{},this.styleRenderers_=[],this.currentFrameStateTransform_=f(),this.tmpTransform_=f(),this.tmpMat4_=x(),this.tileMaskTarget_=null,this.tileMaskIndices_=new E(w,R),this.tileMaskIndices_.fromArray([0,1,3,1,2,3]),this.tileMaskAttributes_=[{name:H.POSITION,size:2,type:C.FLOAT}],this.tileMaskProgram_,this.applyOptions_(t)}reset(e){super.reset(e),this.applyOptions_(e),this.helper&&(this.createRenderers_(),this.initTileMask_())}applyOptions_(e){this.styles_=A(e.style)}createRenderers_(){function e(t){const s=t.getFragmentDiscardExpression(),i=`texture2D(${r.TILE_MASK_TEXTURE}, gl_FragCoord.xy / u_pixelRatio / u_viewportSizePx).r * 50. > ${r.TILE_ZOOM_LEVEL} + 0.5`;t.setFragmentDiscardExpression(s!=="false"?`(${s}) || (${i})`:i),t.addUniform(r.TILE_MASK_TEXTURE,"sampler2D"),t.addUniform(r.TILE_ZOOM_LEVEL,"float")}this.styleRenderers_=this.styles_.map(t=>{const s="builder"in t;let i;if(s)e(t.builder),i=t;else{const a=S(t.style,this.styleVariables_,t.filter);e(a.builder),i={builder:a.builder,attributes:a.attributes,uniforms:a.uniforms}}return new D(i,this.styleVariables_,this.helper,this.hitDetectionEnabled_,"filter"in t?t.filter:null)})}initTileMask_(){this.tileMaskTarget_=new k(this.helper);const e=new F().setFillColorExpression(`vec4(${r.TILE_ZOOM_LEVEL} / 50., 0., 0., 1.)`).addUniform(r.TILE_ZOOM_LEVEL,"float");this.tileMaskProgram_=this.helper.getProgram(e.getFillFragmentShader(),e.getFillVertexShader()),this.helper.flushBufferData(this.tileMaskIndices_)}afterHelperCreated(){this.createRenderers_(),this.initTileMask_()}createTileRepresentation(e){const t=new X(e,this.styleRenderers_),s=()=>{t.ready&&(this.getLayer().changed(),t.removeEventListener(u.CHANGE,s))};return t.addEventListener(u.CHANGE,s),t}beforeTilesRender(e,t){super.beforeTilesRender(e,!0),this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_)}beforeTilesMaskRender(e){this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_);const t=e.pixelRatio,s=e.size;return this.tileMaskTarget_.setSize([s[0]*t,s[1]*t]),this.helper.prepareDrawToRenderTarget(e,this.tileMaskTarget_,!0,!0),this.helper.useProgram(this.tileMaskProgram_,e),T(this.tmpTransform_,this.currentFrameStateTransform_),this.helper.setUniformMatrixValue(r.PROJECTION_MATRIX,h(this.tmpMat4_,this.tmpTransform_)),d(this.tmpTransform_,this.currentFrameStateTransform_),this.helper.setUniformMatrixValue(r.SCREEN_TO_WORLD_MATRIX,h(this.tmpMat4_,this.tmpTransform_)),!0}renderTileMask(e,t,s,i){if(!e.ready)return;this.helper.setUniformFloatValue(r.DEPTH,i),this.helper.setUniformFloatValue(r.TILE_ZOOM_LEVEL,t),this.helper.setUniformFloatVec4(r.RENDER_EXTENT,s),this.helper.setUniformFloatValue(r.GLOBAL_ALPHA,1),this.helper.bindBuffer(e.maskVertices),this.helper.bindBuffer(this.tileMaskIndices_),this.helper.enableAttributes(this.tileMaskAttributes_);const a=this.tileMaskIndices_.getSize();this.helper.drawElements(0,a)}applyUniforms_(e,t,s,i,a){T(this.tmpTransform_,this.currentFrameStateTransform_),V(this.tmpTransform_,s),this.helper.setUniformMatrixValue(r.PROJECTION_MATRIX,h(this.tmpMat4_,this.tmpTransform_)),d(this.tmpTransform_,this.currentFrameStateTransform_),this.helper.setUniformMatrixValue(r.SCREEN_TO_WORLD_MATRIX,h(this.tmpMat4_,this.tmpTransform_)),this.helper.setUniformFloatValue(r.GLOBAL_ALPHA,e),this.helper.setUniformFloatValue(r.DEPTH,a),this.helper.setUniformFloatValue(r.TILE_ZOOM_LEVEL,i),this.helper.setUniformFloatVec4(r.RENDER_EXTENT,t)}renderTile(e,t,s,i,a,c,l,n,m,z,M){const g=I(n,i,n),y=e.tile.getTileCoord()[0];for(let o=0,L=this.styleRenderers_.length;o<L;o++){const b=this.styleRenderers_[o],_=e.buffers[o];_&&b.render(_,s,()=>{this.applyUniforms_(M,g,_.invertVerticesTransform,y,m)})}}renderDeclutter(e){}disposeInternal(){super.disposeInternal()}}class pe extends G{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.style_=e.style,this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){return new W(this,{style:this.style_,variables:this.styleVariables_,disableHitDetection:this.hitDetectionDisabled_})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}setStyle(e){this.style_=e,this.clearRenderer(),this.changed()}}export{pe as default};
//# sourceMappingURL=WebGLVectorTile-B-fS01m4.js.map
