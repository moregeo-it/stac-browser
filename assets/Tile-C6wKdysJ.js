import{f as t,bx as X,aq as K,v as x,be as A,aX as Z,aY as S,E as W,ar as F,x as v,aA as H,bl as N}from"./GeoJSON-dVJCj0SI.js";import{T as w}from"./Tile-G7aX-9AV.js";import{r as z,b as k,a as B,T as P,E as q}from"./common-D17H8Wti.js";class j extends w{constructor(e,s,i,n,a,h){super(e,s,h),this.crossOrigin_=n,this.src_=i,this.key=i,this.image_=new Image,n!==null&&(this.image_.crossOrigin=n),this.unlisten_=null,this.tileLoadFunction_=a}getImage(){return this.image_}setImage(e){this.image_=e,this.state=t.LOADED,this.unlistenImage_(),this.changed()}handleImageError_(){this.state=t.ERROR,this.unlistenImage_(),this.image_=J(),this.changed()}handleImageLoad_(){const e=this.image_;e.naturalWidth&&e.naturalHeight?this.state=t.LOADED:this.state=t.EMPTY,this.unlistenImage_(),this.changed()}load(){this.state==t.ERROR&&(this.state=t.IDLE,this.image_=new Image,this.crossOrigin_!==null&&(this.image_.crossOrigin=this.crossOrigin_)),this.state==t.IDLE&&(this.state=t.LOADING,this.changed(),this.tileLoadFunction_(this,this.src_),this.unlisten_=X(this.image_,this.handleImageLoad_.bind(this),this.handleImageError_.bind(this)))}unlistenImage_(){this.unlisten_&&(this.unlisten_(),this.unlisten_=null)}disposeInternal(){this.unlistenImage_(),this.image_=null,super.disposeInternal()}}function J(){const l=K(1,1);return l.fillStyle="rgba(0,0,0,0)",l.fillRect(0,0,1,1),l.canvas}class tt extends w{constructor(e,s,i,n,a,h,g,d,C,I,R,Y){super(a,t.IDLE,Y),this.renderEdges_=R!==void 0?R:!1,this.pixelRatio_=g,this.gutter_=d,this.canvas_=null,this.sourceTileGrid_=s,this.targetTileGrid_=n,this.wrappedTileCoord_=h||a,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0,this.clipExtent_=e.canWrapX()?e.getExtent():void 0;const L=n.getTileCoordExtent(this.wrappedTileCoord_),D=this.targetTileGrid_.getExtent();let o=this.sourceTileGrid_.getExtent();const f=D?x(L,D):L;if(A(f)===0){this.state=t.EMPTY;return}const c=e.getExtent();c&&(o?o=x(o,c):o=c);const O=n.getResolution(this.wrappedTileCoord_[0]),u=B(e,i,f,O);if(!isFinite(u)||u<=0){this.state=t.EMPTY;return}const b=I!==void 0?I:q;if(this.triangulation_=new P(e,i,f,o,u*b,O),this.triangulation_.getTriangles().length===0){this.state=t.EMPTY;return}this.sourceZ_=s.getZForResolution(u);let r=this.triangulation_.calculateSourceExtent();if(o&&(e.canWrapX()?(r[1]=v(r[1],o[1],o[3]),r[3]=v(r[3],o[1],o[3])):r=x(r,o)),!A(r))this.state=t.EMPTY;else{let E=0,m=0;e.canWrapX()&&(E=H(c),m=Math.floor((r[0]-c[0])/E)),N(r.slice(),e,!0).forEach(G=>{const _=s.getTileRangeForExtentAndZ(G,this.sourceZ_);for(let T=_.minX;T<=_.maxX;T++)for(let p=_.minY;p<=_.maxY;p++){const y=C(this.sourceZ_,T,p,g);if(y){const M=m*E;this.sourceTiles_.push({tile:y,offset:M})}}++m}),this.sourceTiles_.length===0&&(this.state=t.EMPTY)}}getImage(){return this.canvas_}reproject_(){const e=[];if(this.sourceTiles_.forEach(s=>{const i=s.tile;if(i&&i.getState()==t.LOADED){const n=this.sourceTileGrid_.getTileCoordExtent(i.tileCoord);n[0]+=s.offset,n[2]+=s.offset;const a=this.clipExtent_?.slice();a&&(a[0]+=s.offset,a[2]+=s.offset),e.push({extent:n,clipExtent:a,image:i.getImage()})}}),this.sourceTiles_.length=0,e.length===0)this.state=t.ERROR;else{const s=this.wrappedTileCoord_[0],i=this.targetTileGrid_.getTileSize(s),n=typeof i=="number"?i:i[0],a=typeof i=="number"?i:i[1],h=this.targetTileGrid_.getResolution(s),g=this.sourceTileGrid_.getResolution(this.sourceZ_),d=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_);this.canvas_=z(n,a,this.pixelRatio_,g,this.sourceTileGrid_.getExtent(),h,d,this.triangulation_,e,this.gutter_,this.renderEdges_,this.interpolate),this.state=t.LOADED}this.changed()}load(){if(this.state==t.IDLE){this.state=t.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:s})=>{const i=s.getState();if(i==t.IDLE||i==t.LOADING){e++;const n=Z(s,W.CHANGE,a=>{const h=s.getState();(h==t.LOADED||h==t.ERROR||h==t.EMPTY)&&(S(n),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(n)}}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:s},i,n){s.getState()==t.IDLE&&s.load()})}}unlistenSources_(){this.sourcesListenerKeys_.forEach(S),this.sourcesListenerKeys_=null}release(){this.canvas_&&(F(this.canvas_.getContext("2d")),k.push(this.canvas_),this.canvas_=null),super.release()}}export{j as I,tt as R};
//# sourceMappingURL=Tile-C6wKdysJ.js.map
